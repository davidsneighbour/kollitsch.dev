---
import Heading from "@components/content/typography/Heading.astro";
import GroupNav from "@components/pages/releases/GroupNav.astro";
import ReleaseCard from "@components/pages/releases/ReleaseCard.astro";
import setup from "@data/setup.json" with { type: "json" };
import Layout from "@layouts/DefaultPage.astro";
import type { Release } from "@utils/releases.ts";
import {
  filterByMinorGroup,
  getMinorGroups,
  getReleasesPerPage,
  isMinorGroupTag,
  loadAllReleases,
  paginate,
} from "@utils/releases.ts";
import type { APIContext } from "astro";

export const PER_PAGE = getReleasesPerPage(100);

export async function getStaticPaths() {
  const all = await loadAllReleases();
  const totalPages = Math.max(1, Math.ceil(all.length / PER_PAGE));
  const pagePaths = Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
  const groupPaths = getMinorGroups(all).map((group) => ({
    params: { page: group },
  }));
  return [...pagePaths, ...groupPaths];
}

const { params } = Astro as APIContext;
const identifier = params.page ?? "1";
const isGroupView = isMinorGroupTag(identifier);

const all: Release[] = await loadAllReleases();

let releasesToDisplay: Release[] = [];
let prevUrl: string | null = null;
let nextUrl: string | null = null;
let pageLabel: string | null = null;
let heading: string | null = null;
let currentGroup: string | null | undefined;

let post = {
  data: {
    description: setup.description,
    title: "Releases",
  },
};

if (isGroupView) {
  const grouped = filterByMinorGroup(all, identifier);
  if (grouped.length === 0) {
    return Astro.redirect("/releases/");
  }

  releasesToDisplay = grouped;
  currentGroup = identifier;
  pageLabel = `${identifier} releases`;
  heading = `Release group ${identifier}`;
  post = {
    data: {
      description: setup.description,
      title: `Releases – ${identifier}`,
    },
  };
} else {
  const pageNumber = Number.parseInt(identifier, 10);
  if (!Number.isFinite(pageNumber) || pageNumber < 1) {
    return Astro.redirect("/releases/");
  }

  const slice = paginate(all, pageNumber, PER_PAGE);
  releasesToDisplay = slice.items;
  prevUrl = slice.page > 1 ? `/releases/${slice.page - 1}/` : null;
  nextUrl = slice.page < slice.totalPages ? `/releases/${slice.page + 1}/` : null;
  pageLabel = `Page ${slice.page} of ${slice.totalPages}`;
  heading = slice.page === 1 ? "Latest releases" : `Releases page ${slice.page}`;
  currentGroup = slice.page === 1 ? null : undefined;
  post = {
    data: {
      description: setup.description,
      title: `Releases – Page ${slice.page}/${slice.totalPages}`,
    },
  };
}

const showPagination = !isGroupView;
---

<Layout post={post}>
  <GroupNav all={all} currentGroup={currentGroup} />

  {heading ? <Heading level={2}>{heading}</Heading> : null}

  <div class="flex flex-col gap-4">
    {releasesToDisplay.map((r) => <ReleaseCard release={r} />)}
  </div>

  {
    showPagination ? (
      <nav class="mt-6 flex justify-between">
        {prevUrl ? <a href={prevUrl}>Previous</a> : <span />}
        <span>{pageLabel}</span>
        {nextUrl ? <a href={nextUrl}>Next</a> : <span />}
      </nav>
    ) : (
      <p class="mt-6 text-sm opacity-80">{pageLabel}</p>
    )
  }

  <GroupNav all={all} currentGroup={currentGroup} />
</Layout>
