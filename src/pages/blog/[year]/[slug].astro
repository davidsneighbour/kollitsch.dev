---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '@layouts/DefaultPage.astro';
import { resolveImagePath } from '@utils/resolveImagePath';
import { resolveAstroImage } from '@utils/resolveAstroImage';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  return allPosts
    .map((post) => {
      const parts = post.slug.split('/');
      if (parts.length !== 2) {
        console.warn(`[blog] Skipping invalid slug: ${post.slug}`);
        return null;
      }
      const [year, slug] = parts;
      return { params: { year, slug } };
    })
    .filter(Boolean);
}

const urlSlug = `${Astro.params.year}/${Astro.params.slug}`;
const posts = await getCollection('blog');
const post = posts.find((p) => p.slug === urlSlug);

if (!post) {
  throw new Error(`[blog] getStaticPaths returned slug '${urlSlug}', but post was not found in getCollection(). This is a build-time error.`);
}

const imagePath = resolveImagePath(post.data.cover || '', post.id);
const imageMeta = imagePath ? resolveAstroImage(imagePath) : null;

const html = post.rendered?.html ?? '';

const currentIndex = posts.findIndex((p) => p.slug === urlSlug);
const nextPost = posts[currentIndex + 1];
const prevPost = posts[currentIndex - 1];

---

<Layout title={post.data.title} description={post.data.description ?? ''}>

{imagePath && <Image src={imageMeta} alt={post.data.title} class="w-full h-auto mb-4" />}

  <article>
    <h1>{post.data.title}</h1>
    <p>{post.data.date.toLocaleDateString()}</p>
    <div class="
          prose prose-base xs:prose-sm lg:prose-2xl
          prose-neutral
          dark:prose-invert
          max-w-none
  " set:html={html} />
  </article>

  <div class="section--comments">
    <section class="giscus mx-auto mt-10 w-full"></section>
    <script
      src="https://giscus.app/client.js"
      data-repo="davidsneighbour/kollitsch.dev"
      data-repo-id="MDEwOlJlcG9zaXRvcnk0MDU5MjUzNTE="
      data-category="Comments"
      data-category-id="DIC_kwDOGDHt584B_i3-"
      data-mapping="specific"
      data-term={post.data.title}
      data-loading="lazy"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="dark"
      data-lang="en"
      crossorigin="anonymous"
      fetchpriority="high"
      async
      defer
      id="giscus-script">
    </script>
  </div>
</Layout>
