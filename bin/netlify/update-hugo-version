#!/bin/bash

REQUIRED_TOOLS=(
  cat
)

for TOOL in "${REQUIRED_TOOLS[@]}"; do
  if ! command -v "${TOOL}" >/dev/null; then
    echo "${TOOL} is required... "
    exit 1
  fi
done

get_latest_release() {
  curl --silent "https://api.github.com/repos/gohugoio/hugo/releases/latest" |
    grep '"tag_name":' |
    sed -E 's/.*"v([^"]+)".*/\1/'
}

cat <<EOF
[build]
publish = "./public"

[context.production]
command = "./bin/netlify/build"

[context.production.environment]
HUGO_VERSION = "$(get_latest_release)"
HUGO_ENV = "production"
GO_VERSION = "1.17"
NODE_ENV = "development"

[[plugins]]
package = "/bin/netlify/plugins/hugo-helper"

[plugins.inputs]
debug = true

[[redirects]]
from = "https://main--kollitsch.netlify.app/"
to = "/"
status = 301

[[redirects]]
from = "/repos/*"
to = "/"
status = 301

[[redirects]]
from = "/2005/*"
to = "/"
status = 301

[[redirects]]
from = "/2006/*"
to = "/"
status = 301

[[redirects]]
from = "/2007/*"
to = "/"
status = 301

[[redirects]]
from = "/2008/*"
to = "/"
status = 301

###############################################################################
# Setup for server side functions on Netlify
###############################################################################
[functions]
directory = "bin/netlify/functions/"

[functions.healthcheck]
schedule = "*/30 * * * *"

EOF
