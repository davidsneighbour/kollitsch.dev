---
import "@styles/theme.css";

import Breakpoints from "@components/devtools/Breakpoints.astro";
import Head from "@components/layout/Head.astro";
import SchemaWebSite from "@components/seo/schema/WebSite.astro";
import WebComponents from "@components/layout/footer/WebComponents.astro";
import Selection from "@components/gimmicks/Selection.astro";
import setup from "@data/setup.json" with { type: "json" };

const { post, extraHtmlClasses = "", extraBodyClasses = "", frontmatter } = Astro.props;

// html classes
const htmlClasses = [
  "h-full",
  "scroll-smooth", // smooth scrolling fall back for Lenis.js
  "bg-gray-50 dark:bg-gray-950",
  "text-gray-900 dark:text-gray-100",
  extraHtmlClasses,
]
  .filter(Boolean)
  .join(" ");

// body classes
const bodyClasses = [
  "min-h-screen",
  "overflow-y-scroll", // always show scrollbar to prevent layout shift
  "bg-gray-50 dark:bg-gray-950",
  "text-gray-900 dark:text-gray-100",
  extraBodyClasses,
]
  .filter(Boolean)
  .join(" ");

const IS_DEV = import.meta.env.DEV;
---

<!doctype html>
<html lang="en" class={htmlClasses} transition:name="root" transition:animate="initial">
  <head>
    <Head post={post} frontmatter={frontmatter} />
    {import.meta.env.DEV && <link rel="stylesheet" href="/src/styles/auditor.css" />}
  </head>
  <body class={bodyClasses}>
    <slot />
    <Breakpoints />
    <SchemaWebSite />
    <script is:inline define:vars={{ IS_DEV, setup }}>
      (function () {
        if (typeof window === "undefined" || IS_DEV) return;

        const _paq = (window._paq = window._paq || []);
        const u = setup.search.instance;

        _paq.push(["setSiteId", setup.search.siteId]);
        _paq.push(["setTrackerUrl", u + "matomo.php"]);
        _paq.push(["setCookieDomain", setup.search.cookieDomain]);
        _paq.push(["enableLinkTracking"]);

        const g = document.createElement("script");
        g.async = true;
        g.defer = true;
        g.src = u + "matomo.js";

        const target = document.head || document.body || document.documentElement;
        target.appendChild(g);
      })();
    </script>
    <script>
      document.addEventListener("astro:after-swap", () => {
        window.scrollTo({ left: 0, top: 0, behavior: "instant" });
      });
    </script>
    <script is:inline>
      (() => {
        const releaseNavigationLocks = () => {
          document.documentElement.classList.remove("astro-transitioning");
          document.documentElement.removeAttribute("inert");
          document.body?.removeAttribute("inert");
        };

        document.addEventListener("astro:after-swap", releaseNavigationLocks);
        window.addEventListener("pageshow", releaseNavigationLocks);
      })();
    </script>
    <script>
      import Lenis from "lenis";

      (() => {
        /**
         * Keep a single Lenis instance across swaps.
         * Store it on window.kdev to avoid duplicate initialisations.
         */
        const getNamespace = () => {
          /** @type {Window & { kdev?: Record<string, unknown> }} */
          const w = window;
          if (!w.kdev || typeof w.kdev !== "object") w.kdev = {};
          return w.kdev;
        };

        const destroyLenis = () => {
          const ns = getNamespace();
          const existing = ns.lenis;
          if (existing && typeof existing === "object" && "destroy" in existing) {
            try {
              /** @type {{ destroy: () => void }} */ (existing).destroy();
            } catch (e) {
              console.error("[lenis] destroy failed", e);
            }
          }
          ns.lenis = undefined;
        };

        const initLenis = () => {
          const ns = getNamespace();

          // Avoid stacking multiple Lenis instances and wheel listeners.
          destroyLenis();

          try {
            const lenis = new Lenis({
              autoRaf: true,
            });

            // Some bfcache restores benefit from forcing a sync.
            // resize exists in newer Lenis versions; check before calling.
            if (typeof lenis.resize === "function") {
              lenis.resize();
            }

            // start exists in some versions. If present, ensure it is not paused.
            if (typeof lenis.start === "function") {
              lenis.start();
            }

            ns.lenis = lenis;
          } catch (e) {
            console.error("[lenis] init failed", e);
          }
        };

        // Initial load.
        initLenis();

        // Runs after every ClientRouter navigation.
        document.addEventListener("astro:page-load", () => {
          initLenis();
        });

        // Runs on bfcache restore (Back/Forward).
        window.addEventListener("pageshow", () => {
          initLenis();
        });
      })();
    </script>
    <WebComponents post={post} />
    <script>
      import "@tailwindplus/elements";
    </script>
    <Selection />
  </body>
</html>
