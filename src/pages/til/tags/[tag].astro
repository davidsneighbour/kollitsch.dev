---
import Layout from '@layouts/TilPage.astro';
import { getCollection } from 'astro:content';
import GroupedPostList from '@components/til/GroupedPostList.astro';

// Generate static paths for each unique tag
export async function getStaticPaths() {
  const posts = await getCollection('til');
  const tags = new Set<string>();

  for (const post of posts) {
    for (const tag of post.data.tags ?? []) {
      tags.add(tag);
    }
  }

  return Array.from(tags).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const allPosts = await getCollection('til');

const posts = allPosts
  .filter(post => (post.data.tags ?? []).includes(tag))
  .sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
  );
---

<Layout>
  <section class="mx-auto max-w-4xl py-8">
    <h1 class="mb-6 text-2xl font-bold">TIL tagged with "{tag}"</h1>
    {
      posts.length > 0 ? (
        <GroupedPostList posts={posts} />
      ) : (
        <p>No posts found under this tag.</p>
      )
    }
  </section>
</Layout>
