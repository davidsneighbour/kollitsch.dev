# TODO: check a way to load a list of URLs from JSON
# see https://github.com/treosh/lighthouse-ci-action/issues/95
# see https://github.com/patternfly/patternfly-elements/blob/9035f4e4d32fee407cbf49740ce2fca9aec9e2fc/.github/workflows/visual-regression.yml#L50-L75

name: Lighthouse CI

on: push

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - run: npm install

      - name: Wait for the Netlify Preview
        # https://github.com/JakePartusch/wait-for-netlify-action
        uses: jakepartusch/wait-for-netlify-action@v1
        id: netlify
        with:
          site_name: "kollitsch"

      - name: Audit URLs using Lighthouse for desktop
        # https://github.com/treosh/lighthouse-ci-action
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            ${{ steps.netlify.outputs.url }}
            ${{ steps.netlify.outputs.url }}/page/2/
            ${{ steps.netlify.outputs.url }}/page/3/
          budgetPath: ./etc/lighthouse/budget.json
          configPath: ./etc/lighthouse/config-desktop.js
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      # - name: Webhook
      #   uses: denar90/webhook-action@0.1.1
      #   with:
      #     webhookUrl: ${{secrets.ACTION_WEBHOOK_URL}}
      #     data: '{ "links": ${{steps.LHCIAction.outputs.links}}, "manifest": ${{steps.LHCIAction.outputs.manifest}} }'

      - name: Audit URLs using Lighthouse for mobile
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            https://kollitsch.dev/
            https://kollitsch.dev/page/2/
            https://kollitsch.dev/page/3/
          budgetPath: ./etc/lighthouse/budget.json
          configPath: ./etc/lighthouse/config-mobile.js
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
