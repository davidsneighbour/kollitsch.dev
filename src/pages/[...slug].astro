---

// this layout will match all routes that don't have a specific page defined

import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/DefaultPage.astro';
import { logDebug } from '@utils/helpers.js';

// Load all `pages` collection entries
const entries = await getCollection('pages');

// Get the current route (slug)
const path = Astro.url.pathname.replace(/\/$/, '') || '/';

// Find matching entry by slug or derived URL from folder structure
const post = entries.find(
  entry => entry.data.slug === path || '/' + entry.slug === path,
);

if (!post || post.data?.draft) {
  throw new Error(`No matching page for path: ${path}`);
}

if (!post || post.data?.draft || !post.rendered?.html) {
  logDebug(`No renderable page found for path: ${path}`);
  //throw new Error(`No matching or renderable page for path: ${path}`);
}

export async function getStaticPaths() {
  const entries = await getCollection('pages');

  return entries
    .filter(entry => !entry.data?.draft)
    .map(entry => {
      const url = entry.data?.slug || '/' + entry.slug;
      return {
        params: {
          slug: url.replace(/^\/+/, ''), // must be a string
        },
      };
    });
}
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article set:html={post.rendered?.html ?? ''} />
</BaseLayout>
