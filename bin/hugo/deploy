#!/bin/bash

set -euo pipefail # http://redsymbol.net/articles/unofficial-bash-strict-mode

REQUIRED_TOOLS=(
  hugo
  node
  npm
  netlify
)

for TOOL in "${REQUIRED_TOOLS[@]}"; do
  if ! command -v "${TOOL}" >/dev/null; then
    echo "${TOOL} is required... "
    exit 1
  fi
done

FILE=.env
if [ -f "$FILE" ]; then
  set -a
  # shellcheck source=/dev/null
  source "${FILE}"
  set +a
fi

# quietly shutting down concurring hugo servers
killall -q -9 hugo

# get the version number
VERSION=$(node -pe 'require("./package.json")["version"]')

# HASH=$(git log -n 1 | head -n 1 | sed -e 's/^commit //' | head -c 8)
# BASEURL="https://${HASH}--${NETLIFY_SITE_SLUG}.netlify.app"
# bin/build/hugo "${BASEURL}"
# netlify deploy --open --alias "$HASH"

./bin/hugo/build
npm run pagefind

# and deploy
netlify deploy --prod --open --message "Release v${VERSION}"

# and clear cloudflare cache
node bin/services/purge-cloudflare-cache.mjs
