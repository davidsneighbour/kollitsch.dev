---
import ArticleCard from "@components/content/article/Preview.astro";
import BlogHeading from "@components/content/taxonomy/BlogHeading.astro";
import Pagination from "@/components/content/pagenav/Pagination.astro";
import Layout from "@layouts/DefaultPage.astro";
import { getPostsSortedByDraft, paginateBlogPostsByYear } from "@utils/content.ts";
import { createLogger } from "@utils/logger.ts";

export async function getStaticPaths() {
  const pageSize = 12;
  const { getCollection } = await import("astro:content");
  const allPosts = getPostsSortedByDraft(await getCollection("blog"));

  const postsByYear: Record<string, number> = {};
  for (const post of allPosts) {
    const y = new Date(post.data.date).getFullYear().toString();
    postsByYear[y] = (postsByYear[y] ?? 0) + 1;
  }

  return Object.entries(postsByYear).flatMap(([year, count]) => {
    const pages = Math.ceil(count / pageSize);
    return Array.from({ length: pages - 1 }, (_, i) => ({
      params: { page: `${i + 2}`, year },
    }));
  });
}

const { year, page } = Astro.params;
const currentPage = parseInt(page, 10);
const pageSize = 12;

const { posts, totalPages } = await paginateBlogPostsByYear(year, currentPage, pageSize);

const log = createLogger({ slug: "blog-year-page" });
if (import.meta.env.DEV) {
  log.debug(`Loaded blog year page ${year} #${currentPage} (param: ${page})`);
}
---

<Layout title={`Blog posts from ${year} â€“ Page ${currentPage}`}>
  <BlogHeading
    title={`Blog Posts from ${year}`}
    posts={posts}
    level={1}
    description="Explore our collection of blog posts from this year."
  />
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
    {posts.map((post) => <ArticleCard post={post} />)}
  </div>
  <Pagination currentPage={currentPage} totalPages={totalPages} basePath={`/blog/${year}/`} />
</Layout>
