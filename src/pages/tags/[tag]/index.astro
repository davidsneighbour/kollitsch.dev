---
/**
 * Tag overview page
 * Lists all posts with the given tag (supports id or alias in the URL param).
 *
 * Uses the new @utils/tags facade:
 * - getStaticPaths(): built from canonical tag IDs via getAllTagIds()
 * - runtime: resolves incoming param (id/alias/label) via getTag()
 */
import { getEntry } from "astro:content";
import ArticleCard from "@components/content/article/Preview.astro";
import Pagination from "@/components/layout/pagenavigation/Pagination.astro";
import TagIntro from "@components/content/taxonomy/TagIntro.astro";
import setup from "@data/setup.json" with { type: "json" };
import Layout from "@layouts/DefaultPage.astro";

import { getAllTagIds, getTag, tagUrl } from "@utils/tags.ts";

const { tag: rawParam } = Astro.params;

// Resolve the incoming param (can be id, alias, or label) to canonical id + posts
const resolved = await getTag(rawParam);

// If resolution fails, show a clear error (will surface during build for unknown paths)
if (!resolved) {
  throw new Error(`Tag '${rawParam}' not found`);
}

const { id: canonicalId, label: canonicalLabel, posts: taggedPosts } = resolved;

// Try to load the tag entry by canonical id for intro metadata (image/description etc.)
const tagEntry = await getEntry({ collection: "tags", id: canonicalId }).catch(() => null);

// Pagination (first page only; extend if you add /page/[n]/)
const limit = setup.listpages?.limit || 12;
const pageSize = limit;
const currentPage = 1;
const totalPages = Math.ceil(taggedPosts.length / pageSize);
const paginatedPosts = taggedPosts.slice(0, pageSize);

// Metadata
const post = {
  data: {
    description: tagEntry?.data.description || `Posts tagged with #${canonicalLabel}`,
    title: `#${canonicalLabel}`,
  },
};

/**
 * Build static paths from canonical IDs.
 * This ensures aliases resolve to their canonical route, e.g. 'kollitsch' -> 'kdev'
 */
export async function getStaticPaths() {
  const ids = await getAllTagIds();
  return ids.map((id) => ({
    params: { tag: id }, // canonical id
  }));
}
---

<Layout post={post}>
  {
    tagEntry && (
      <TagIntro
        title={tagEntry.data.title}
        description={tagEntry?.data.description || `Posts tagged with #${canonicalLabel}`}
      />
    )
  }

  {!tagEntry && <h1 class="mb-6 text-4xl">#{canonicalLabel}</h1>}

  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4">
    {paginatedPosts.map((post) => <ArticleCard post={post} />)}
  </div>

  <Pagination basePath={tagUrl(canonicalId)} currentPage={currentPage} totalPages={totalPages} pagingPartial="/page/" />
</Layout>
