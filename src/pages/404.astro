---
import { getImage } from "astro:assets";
import image404 from "@assets/images/404.jpg";
import IconLink from "@components/shared/links/IconLink.astro";
import Site from "@layouts/Site.astro";

const optimizedBackground = await getImage({
  format: "jpg",
  quality: 80,
  src: image404,
  width: 1920,
});

const currentPath = Astro.url.pathname;
const post = {
  date: new Date(),
  description: "The page you are looking for does not exist.",
  tags: ["404", "error"],
  title: "404 Page Not Found - " + currentPath,
};
---

<Site
  post={post}
  extraBodyClasses="h-full"
>
  <div
    class="relative h-full bg-cover bg-center text-center"
    style={`background-image: url(${optimizedBackground.src});`}
  >
    <main class="absolute inset-0 z-10">
      <p class="font-changa text-9xl leading-8">404</p>
      <h1>Page not found</h1>
      <p class="">Sorry, we couldn't find the page you're looking for.</p>
      <nav class="mt-8 flex flex-col items-center gap-4">
        <IconLink
          icon="arrow-left-short"
          href="#"
          onclick="history.back();"
        >
          Go Back
        </IconLink>
        <IconLink
          icon="house-door"
          href="/"
        >
          Home
        </IconLink>
        <IconLink
          icon="envelope"
          href="/connect/"
        >
          Contact Us
        </IconLink>
      </nav>
    </main>
  </div>
  <script is:inline>
    (function () {
      if (typeof window === "undefined") return;
      try {
        const _paq = (window._paq = window._paq || []);
        const path = location.pathname;
        const ref = document.referrer || "(direct)";

        // _paq.push(['setCustomDimension', 1, '404']);

        _paq.push(["setReferrerUrl", ref]);
        _paq.push(["trackEvent", "Issue", "404 - Not Found", path]);

        // If you have SPA transitions that can reach a 404 route, send once per view:
        const once = () => {
          _paq.push(["setCustomDimension", 1, "404"]);
          _paq.push(["setReferrerUrl", document.referrer || "(direct)"]);
          _paq.push(["trackEvent", "Issue", "404 - Not Found", location.pathname]);
        };
        document.addEventListener("astro:after-swap", once, { once: true });
      } catch (err) {
        console.error("Matomo 404 event tracking failed:", err);
      }
    })();
  </script>
</Site>
