---
// @todo refactor

import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '@layouts/DefaultPage.astro';
import { resolveImagePath } from '@utils/resolveImagePath';
import { resolveAstroImage } from '@utils/resolveAstroImage';
import type { ImageMetadata } from "astro";
import Giscus from '@components/Giscus.astro';
import BreadCrumbs from '@components/BreadCrumbs.astro';
import Prose from '@components/Prose.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  return allPosts
    .map((post) => {
      const parts = post.slug.split('/');
      if (parts.length !== 2) {
        console.warn(`[blog] Skipping invalid slug: ${post.slug}`);
        return null;
      }
      const [year, slug] = parts;
      return { params: { year, slug } };
    })
    .filter(Boolean);
}

const urlSlug = `${Astro.params.year}/${Astro.params.slug}`;
const posts = await getCollection('blog');
const post = posts.find((p) => p.slug === urlSlug);

if (!post) {
  throw new Error(`[blog] getStaticPaths returned slug '${urlSlug}', but post was not found in getCollection(). This is a build-time error.`);
}

const imagePath = resolveImagePath(post.data.cover || '', post.id);
const imageMeta: ImageMetadata | null = imagePath ? resolveAstroImage(imagePath) : null;

const html = post.rendered?.html ?? '';

const currentIndex = posts.findIndex((p) => p.slug === urlSlug);
const nextPost = posts[currentIndex + 1];
const prevPost = posts[currentIndex - 1];

---

<Layout title={post.data.title} description={post.data.description ?? ''}>

  <article>

    {imageMeta && <Image src={imageMeta} alt={post.data.title} class="w-full h-auto mb-4" width="1280" />}
    <h2>{post.data.title}</h2>
    <p>{post.data.date.toLocaleDateString()}</p>
    <BreadCrumbs path={Astro.url.href} />
    <Prose set:html={html} />

    <div class="flex justify-between">
      {prevPost && (
        <a href={`/blog/${prevPost.slug}/`} class="text-blue-500 hover:underline">
          ← {prevPost.data.title}
        </a>
      )}
      {nextPost && (
        <a href={`/blog/${nextPost.slug}/`} class="text-blue-500 hover:underline">
          {nextPost.data.title} →
        </a>
      )}
    </div>

    <Giscus post={post} />

  </article>
</Layout>
