{{- $drafts := partialCached "dnb-feeds/getDrafts.html" "rss" . -}}
{{- $items := partialCached "dnb-feeds/getItemsToShow.html" "rss" . -}}

{{- $context := . -}}
{{- if .IsHome -}}
  {{- $context = .Site -}}
{{- end -}}

{{- $pages := $context.RegularPages -}}
{{- with site.Params.dnb.feeds.items -}}
  {{- if eq . "posts" -}}
    {{- $pages = where $context.RegularPages "Type" "in" site.Params.mainSections -}}
  {{- end -}}
{{- end -}}

{{ with $drafts }}
  {{- $pages := where $pages "Draft" "==" . -}}
{{ end }}

{{- $limit := partialCached "dnb-feeds/getLimit.html" "rss" . -}}
{{- $pages = $pages | first $limit -}}

{{ printf "<?xml version= \"1.0\" encoding= \"utf-8\" standalone= \"yes\"?>" | safeHTML }}<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>
    {{- if eq .Title site.Title -}}
      {{- site.Title -}}
    {{- else -}}
      {{- with .Title -}}
        {{- . -}} on
      {{- end -}}
      {{- site.Title -}}
    {{- end -}}
</title>
    <link>{{- .Permalink -}}</link>
    <description>
      Recent content
      {{ if ne .Title site.Title -}}
        {{- with .Title }} in {{ . }} {{ end -}}
      {{- end }}
      on {{ site.Title -}}
    </description>
    {{- with site.LanguageCode -}}
    <language>{{- . -}}</language>
    {{- end -}}
    {{- with site.Author.name -}}
      <managingEditor>{{.}}</managingEditor>
      <webMaster>{{.}}</webMaster>
    {{- end -}}
    {{- with site.Copyright -}}
      <copyright>{{- . -}}</copyright>
    {{- end -}}
    {{- if not .Date.IsZero -}}
    <lastBuildDate>{{- .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML -}}</lastBuildDate>
    {{- end -}}
    <atom:link href="{{.Permalink}}" rel="self" type="application/rss+xml" />
    {{- range $pages -}}
    <item>
      <title>{{- .Title -}}</title>
      <link>{{- .Permalink -}}</link>
      <pubDate>{{- .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML -}}</pubDate>
      {{- with site.Author.name -}}
        <author>{{- . -}}</author>
      {{- end -}}
      <guid>
        {{- .Permalink -}}
      </guid>
      <description>
        {{- .Content | html -}}
      </description>
    </item>
    {{- end -}}
  </channel>
</rss>
