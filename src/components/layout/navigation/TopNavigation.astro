---
// @todo refactor and comment
// astro imports
import { fade } from "astro:transitions";
import IconLink from "@components/shared/links/IconLink.astro";

import type { Navigation } from "@utils/navigation";

// components
import ProgressBar from "@components/layout/navigation/Progress.astro";
// data
import setup from "@data/setup.json" with { type: "json" };
import navData from "@data/topnavigation.json" with { type: "json" };
// utilities
import { getHomepageUrl } from "@utils/content.ts";
import { createLogger } from "@utils/logger.ts";
import { findActive, isActive } from "@utils/navigation.ts";
import { Icon } from "astro-icon/components";

const typedNavData = navData as Navigation;

const log = createLogger({ slug: "TopNavigation" });

const pathname = Astro.url.pathname;
const activeItem = findActive(typedNavData, pathname);

if (!activeItem && import.meta.env.DEV) {
  log.debug(`ðŸ‘‰ no navigation item to activate for: ${pathname}`);
}

// Theme Manager Component
// The theme on kollitsch.dev is managed by adding a `data-theme` attribute to
// the `<html>` element which can have the values `light`, or `dark`
type ThemeMode = "dark" | "light";
export interface Props {
  defaultTheme?: ThemeMode;
}

const { defaultTheme = "dark" }: Props = Astro.props;
---

<header
  class="sticky top-0 right-0 left-0 isolate z-50 mb-12 bg-zinc-100 [--thickness:4px] lg:[--thickness:6px] dark:bg-zinc-900"
  aria-label="Top navigation bar with site title, navigation links, and theme selector"
>
  <nav class="mx-auto max-w-7xl" aria-label="Main navigation">
    <div class="backdrop pointer-events-none absolute inset-0 z-10 bg-gray-100 backdrop-blur-lg dark:bg-gray-900"></div>
    <div class="backdrop-edge absolute right-0 bottom-0 left-0 z-10 h-[var(--thickness)]">
      <ProgressBar classes="progress z-40 relative [--height:var(--thickness)]" />
    </div>
    <div
      class="z-20 flex flex-wrap items-center gap-4 bg-zinc-100 text-gray-950 md:flex-nowrap md:items-start dark:bg-zinc-900 dark:text-gray-50"
    >
      <div class="z-30 order-1 flex-1" id="navbar-sitetitle">
        <a
          id="navbar-brand"
          href={getHomepageUrl()}
          class="font-changa flex-rows flex items-center gap-2 p-1.5 text-2xl opacity-0 transition-opacity duration-600 ease-in-out"
        >
          <Icon name="house-fill" class="place-self-center" />
          {setup.title}
        </a>
      </div>
      <div class="z-30 order-2 md:hidden" id="hamburger-and-close">
        <Icon
          name="list"
          class="is--mobile-menu-hamburger open-icon text-brand-500 dark:text-brand-400 place-self-center text-xl"
        />
        <Icon
          name="x"
          class="is--mobile-menu-hamburger close-icon text-brand-500 dark:text-brand-400 hidden place-self-center text-xl"
        />
      </div>
      <div
        class="z-30 order-3 w-full justify-center self-center text-center md:order-2 md:ml-auto md:w-auto"
        id="navigation-and-theme-select"
      >
        <ul
          class="flex flex-col justify-center md:flex-row md:justify-end"
          transition:animate={fade({ duration: "0.4s" })}
        >
          {
            typedNavData.map((value) => (
              <li class={`px-3 py-4 md:px-2 md:py-2 ${isActive(value, pathname) ? "font-bold" : ""}`}>
                <IconLink icon={value.icon} href={value.link}>
                  {value.label}
                </IconLink>
              </li>
            ))
          }
          <li class="px-3 py-4 md:px-2 md:py-2">
            <div class="nav-search-container" id="nav-search">
              <form class="nav-search-form" role="search" aria-label="Site search">
                <label class="sr-only" for="nav-search-input">Search site</label>
                <div class="nav-search-shell" aria-hidden="false">
                  <Icon name="search" class="text-gray-500 dark:text-gray-300" aria-hidden="true" />
                  <input
                    id="nav-search-input"
                    class="nav-search-input"
                    type="search"
                    name="q"
                    inputmode="search"
                    placeholder="Search"
                    autocomplete="off"
                    aria-expanded="false"
                  />
                  <button type="button" class="nav-search-clear" aria-label="Clear search" title="Clear search">
                    <Icon name="x" aria-hidden="true" />
                  </button>
                </div>
              </form>
              <div class="nav-search-results" aria-live="polite" aria-atomic="true" aria-hidden="true">
                <div class="nav-search-results-panel">
                  <p class="nav-search-status" role="status">Type to search</p>
                  <ul class="nav-search-results-list" role="list"></ul>
                </div>
              </div>
            </div>
          </li>
          <li class="px-3 py-4 md:px-2 md:py-2">
            <theme-selector></theme-selector>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<style>
  .nav-search-container {
    position: relative;
    width: 3rem;
    transition: width 200ms ease, background-color 150ms ease;
  }

  @media (min-width: 768px) {
    .nav-search-container {
      width: 7rem;
    }
  }

  .nav-search-container.is-expanded {
    width: min(32rem, 90vw);
  }

  .nav-search-form {
    margin: 0;
  }

  .nav-search-shell {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    border-radius: 9999px;
    padding: 0.45rem 0.75rem;
    background-color: rgba(255, 255, 255, 0.82);
    border: 1px solid rgba(24, 24, 27, 0.12);
    box-shadow: 0 8px 28px rgba(0, 0, 0, 0.08);
    cursor: text;
  }

  .dark .nav-search-shell {
    background-color: rgba(24, 24, 27, 0.92);
    border-color: rgba(255, 255, 255, 0.12);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
  }

  .nav-search-input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: inherit;
    font-size: 0.95rem;
  }

  .nav-search-input::placeholder {
    color: #9ca3af;
  }

  .dark .nav-search-input::placeholder {
    color: #9ca3af;
  }

  .nav-search-clear {
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    display: none;
  }

  .nav-search-clear.is-visible {
    display: inline-flex;
  }

  .nav-search-results {
    position: absolute;
    inset-inline: 0;
    margin-top: 0.75rem;
    display: none;
  }

  .nav-search-results.is-visible {
    display: block;
  }

  .nav-search-results-panel {
    background: #ffffff;
    border-radius: 1rem;
    border: 1px solid rgba(24, 24, 27, 0.08);
    box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
    overflow: hidden;
  }

  .dark .nav-search-results-panel {
    background: #0b0b0f;
    border-color: rgba(255, 255, 255, 0.12);
    box-shadow: 0 20px 45px rgba(0, 0, 0, 0.32);
  }

  .nav-search-status {
    margin: 0;
    padding: 0.85rem 1rem;
    color: #6b7280;
  }

  .dark .nav-search-status {
    color: #d1d5db;
  }

  .nav-search-results-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-search-result {
    border-top: 1px solid rgba(24, 24, 27, 0.06);
  }

  .nav-search-result:first-of-type {
    border-top: none;
  }

  .nav-search-result__link {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1rem;
    color: inherit;
    text-decoration: none;
  }

  .nav-search-result__link:hover,
  .nav-search-result__link:focus-visible {
    background: rgba(37, 99, 235, 0.08);
    outline: none;
  }

  .dark .nav-search-result__link:hover,
  .dark .nav-search-result__link:focus-visible {
    background: rgba(94, 234, 212, 0.15);
  }

  .nav-search-result__title {
    font-weight: 700;
  }

  .nav-search-result__excerpt {
    color: #4b5563;
    font-size: 0.9rem;
    line-height: 1.4;
    grid-column: 1 / -1;
  }

  .dark .nav-search-result__excerpt {
    color: #d1d5db;
  }

  .nav-search-result__shortcut {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .dark .nav-search-result__shortcut {
    color: #9ca3af;
  }

  @media (prefers-reduced-motion: reduce) {
    .nav-search-container {
      transition: none;
    }

    .nav-search-result__link:hover,
    .nav-search-result__link:focus-visible {
      transition: none;
    }
  }
</style>

<script is:inline data-astro-rerun data-default-theme={defaultTheme} data-pagefind-base={import.meta.env.BASE_URL ?? "/"}>
  (() => {
    // ---- Shared utilities ----
    window.kdev = window.kdev || {};
    window.kdev.mobileOpen = false;
    window.kdev.navSearch ??= {};
    const thisScript = document.currentScript;
    const closeIcon = document.querySelector(".close-icon");
    const openIcon = document.querySelector(".open-icon");
    const navSection = document.querySelector("#navigation-and-theme-select");
    const placeholder = document.querySelector("#sitetitle");
    const stickyBrand = document.querySelector("#navbar-brand");
    const pagefindSource = new URL(
      "pagefind/pagefind.js",
      thisScript?.dataset.pagefindBase && thisScript.dataset.pagefindBase.trim() !== ""
        ? thisScript.dataset.pagefindBase
        : "/",
    ).pathname;

    // Toggle icons: hamburger â†” close
    const toggleIcons = () => {
      closeIcon?.classList.toggle("hidden", !window.kdev.mobileOpen);
      openIcon?.classList.toggle("hidden", window.kdev.mobileOpen);
    };

    // Show/hide nav links based on viewport & mobile state
    const toggleNavVisibility = () => {
      const isMdUp = window.matchMedia("(min-width: 768px)").matches;
      const shouldShow = isMdUp || window.kdev.mobileOpen;
      navSection?.classList.toggle("hidden", !shouldShow);
      navSection?.classList.toggle("flex", shouldShow);
    };

    // Initialize hamburger click handler & nav visibility
    function initMobileMenu() {
      window.kdev.mobileOpen = false;
      toggleIcons();
      toggleNavVisibility();

      const menuToggle = document.querySelector("#hamburger-and-close");
      if (menuToggle) {
        // replace to remove old listener
        const clone = menuToggle.cloneNode(true);
        menuToggle.replaceWith(clone);
        clone.addEventListener("click", () => {
          window.kdev.mobileOpen = !window.kdev.mobileOpen;
          toggleIcons();
          toggleNavVisibility();
        });
      }
    }

    // Intersection Observer for sticky logo fade
    function initStickyBrandObserver() {
      if (!placeholder || !stickyBrand) {
        console.warn("Placeholder or sticky brand element not found.");
        return;
      }
      const observer = new IntersectionObserver(
        ([entry]) => {
          stickyBrand.classList.toggle("opacity-100", !entry.isIntersecting);
          stickyBrand.classList.toggle("opacity-0", entry.isIntersecting);
        },
        { threshold: 0 },
      );
      observer.observe(placeholder);

      // Set initial state
      const isIntersecting =
        placeholder.getBoundingClientRect().top >= 0 && placeholder.getBoundingClientRect().bottom > 0;
      stickyBrand.classList.toggle("sticky-visible", !isIntersecting);
    }

    function ensureNavSearchGlobals() {
      const navState = window.kdev.navSearch;
      if (navState.globalAttached) return;

      const onDocumentClick = (event) => {
        const { container, collapse } = navState.current ?? {};
        if (!container || !collapse) return;
        if (!container.contains(event.target)) {
          collapse({ force: true });
        }
      };

      const onKeydown = (event) => {
        const nav = navState.current;
        if (!nav) return;

        if (event.ctrlKey && !event.shiftKey && !event.altKey) {
          if (event.key.toLowerCase() === "s") {
            event.preventDefault();
            nav.expand?.();
            nav.input?.focus();
            nav.input?.select();
            return;
          }

          const digit = Number.parseInt(event.key, 10);
          if (Number.isInteger(digit) && digit > 0) {
            const opened = nav.openResult?.(digit - 1);
            if (opened) {
              event.preventDefault();
            }
            return;
          }
        }

        if (event.key === "Escape") {
          nav.collapse?.({ force: true });
        }
      };

      document.addEventListener("click", onDocumentClick);
      document.addEventListener("keydown", onKeydown);
      navState.globalAttached = true;
      navState.teardownGlobals = () => {
        document.removeEventListener("click", onDocumentClick);
        document.removeEventListener("keydown", onKeydown);
        navState.globalAttached = false;
      };
    }

    function initNavigationSearch() {
      const navState = window.kdev.navSearch;
      const searchContainer = document.querySelector("#nav-search");
      const searchInput = searchContainer?.querySelector("input[type='search']");
      const searchShell = searchContainer?.querySelector(".nav-search-shell");
      const searchForm = searchContainer?.querySelector("form");
      const clearButton = searchContainer?.querySelector(".nav-search-clear");
      const resultsPanel = searchContainer?.querySelector(".nav-search-results");
      const resultsList = searchContainer?.querySelector(".nav-search-results-list");
      const status = searchContainer?.querySelector(".nav-search-status");

      if (!searchContainer || !searchInput || !resultsPanel || !resultsList || !status) {
        return;
      }

      let debounceId;
      let latestQuery = "";
      navState.current = {
        anchors: [],
        container: searchContainer,
        input: searchInput,
      };

      const toggleResults = (show) => {
        resultsPanel.classList.toggle("is-visible", show);
        resultsPanel.setAttribute("aria-hidden", show ? "false" : "true");
      };

      const setStatus = (text) => {
        status.textContent = text;
      };

      const updateClearButton = () => {
        const hasValue = Boolean(searchInput.value.trim());
        clearButton?.classList.toggle("is-visible", hasValue);
      };

      const expand = () => {
        searchContainer.classList.add("is-expanded");
        searchInput.setAttribute("aria-expanded", "true");
      };

      const collapse = ({ force = false } = {}) => {
        if (force || !searchInput.value.trim()) {
          searchContainer.classList.remove("is-expanded");
          toggleResults(false);
          searchInput.setAttribute("aria-expanded", "false");
        }
      };

      const createResultItem = (data, index) => {
        const item = document.createElement("li");
        item.className = "nav-search-result";
        const anchor = document.createElement("a");
        anchor.className = "nav-search-result__link";
        anchor.href = data.url;
        anchor.setAttribute("role", "option");
        anchor.setAttribute(
          "aria-label",
          `${index + 1}. ${data.meta?.title || data.url}`,
        );

        const title = document.createElement("span");
        title.className = "nav-search-result__title";
        title.textContent = data.meta?.title || data.url;

        const excerpt = document.createElement("span");
        excerpt.className = "nav-search-result__excerpt";
        excerpt.innerHTML = data.excerpt || "";

        const shortcut = document.createElement("span");
        shortcut.className = "nav-search-result__shortcut";
        shortcut.textContent = `Ctrl+${index + 1}`;

        anchor.append(title, excerpt, shortcut);
        item.append(anchor);
        return { anchor, item };
      };

      const renderResults = (data) => {
        resultsList.innerHTML = "";
        navState.current.anchors = [];
        data.forEach((entry, index) => {
          const { item, anchor } = createResultItem(entry, index);
          navState.current.anchors.push(anchor);
          resultsList.append(item);
        });
      };

      const performSearch = async (term) => {
        const query = term.trim();
        latestQuery = query;
        updateClearButton();
        if (!query) {
          setStatus("Type to search");
          toggleResults(false);
          resultsList.innerHTML = "";
          return;
        }

        expand();
        toggleResults(true);
        setStatus(`Searching for â€œ${query}â€â€¦`);

        try {
          navState.pagefindPromise ??= import(pagefindSource);
          const pagefind = await navState.pagefindPromise;
          const searchResult = await pagefind.search(query);
          const results = await Promise.all(searchResult.results.slice(0, 8).map((res) => res.data()));

          if (latestQuery !== query) {
            return;
          }

          if (!results.length) {
            setStatus(`No matches for â€œ${query}â€.`);
            resultsList.innerHTML = "";
            return;
          }

          renderResults(results);
          const label = results.length === 1 ? "1 result" : `${results.length} results`;
          setStatus(`${label} for â€œ${query}â€. Use Ctrl+1â€¦9 to open.`);
        } catch (error) {
          console.error("pagefind search failed", error);
          setStatus("Search is currently unavailable.");
        }
      };

      const scheduleSearch = (term) => {
        window.clearTimeout(debounceId);
        debounceId = window.setTimeout(() => performSearch(term), 160);
      };

      const handleInput = (event) => {
        const value = event.target.value;
        expand();
        toggleResults(true);
        scheduleSearch(value);
      };

      searchInput.addEventListener("input", handleInput);
      searchInput.addEventListener("focus", () => {
        expand();
        if (searchInput.value.trim()) {
          toggleResults(true);
        }
      });

      searchForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        expand();
        performSearch(searchInput.value);
      });

      searchShell?.addEventListener("click", () => {
        expand();
        searchInput.focus();
      });

      clearButton?.addEventListener("click", (event) => {
        event.preventDefault();
        searchInput.value = "";
        updateClearButton();
        resultsList.innerHTML = "";
        setStatus("Type to search");
        collapse({ force: true });
        searchInput.focus();
      });

      navState.current.expand = expand;
      navState.current.collapse = collapse;
      navState.current.openResult = (index) => {
        const anchor = navState.current.anchors?.[index];
        if (!anchor) return false;
        anchor.focus();
        anchor.click();
        return true;
      };

      updateClearButton();
      ensureNavSearchGlobals();
      collapse();
    }

    function changeGiscusTheme(t = "dark") {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: t } } }, "https://giscus.app");
    }

    window.theme ??= (() => {
      const defaultTheme = document.currentScript.getAttribute("data-default-theme");
      const storageKey = "kdev-theme";
      const store =
        typeof localStorage !== "undefined"
          ? localStorage
          : {
              getItem: () => null,
              setItem: () => {},
            };

      const mediaMatcher = window.matchMedia("(prefers-color-scheme: dark)");
      let systemTheme = mediaMatcher.matches ? "dark" : "light";
      mediaMatcher.addEventListener("change", (e) => {
        systemTheme = e.matches ? "dark" : "light";
        applyTheme(theme.getTheme());
      });

      function applyTheme(t) {
        const resolved = t === "auto" ? systemTheme : t;

        const codeTheme = resolved === "dark" ? "dracula" : "light-plus";
        document.documentElement.dataset.codeTheme = codeTheme;
        document.documentElement.dataset.theme = resolved;
        document.documentElement.style.colorScheme = resolved;
        changeGiscusTheme(t);
        document.dispatchEvent(
          new CustomEvent("theme-changed", {
            detail: { defaultTheme, systemTheme, theme: t },
          }),
        );
      }

      return {
        getSystemTheme: () => systemTheme,
        getTheme: () => store.getItem(storageKey) || defaultTheme,
        resetTheme: () => store.removeItem(storageKey),
        setTheme(t = defaultTheme) {
          store.setItem(storageKey, t);
          applyTheme(t);
        },
      };
    })();

    window.theme.setTheme(window.theme.getTheme());

    // Theme-selector web component + theme manager
    function initThemeManager() {
      if (!customElements.get("theme-selector")) {
        customElements.define(
          "theme-selector",
          class extends HTMLElement {
            connectedCallback() {
              this.themes = ["light", "dark"];
              this.btn = document.createElement("button");
              this.btn.setAttribute("aria-label", "Toggle theme");
              this.btn.addEventListener("click", () => this.nextTheme());
              this.appendChild(this.btn);
              this.updateIcon();
              document.addEventListener("theme-changed", () => this.updateIcon());
            }
            nextTheme() {
              try {
                const current = theme.getTheme();
                const idx = this.themes.indexOf(current);
                const realIdx = idx >= 0 ? idx : this.themes.indexOf(theme.getSystemTheme());
                const next = this.themes[(realIdx + 1) % this.themes.length];
                theme.setTheme(next);
              } catch (err) {
                console.error("theme-selector - cycle error:", err);
              }
            }
            updateIcon(t = theme.getTheme()) {
              const icons = { dark: "ðŸŒ™", light: "â˜€ï¸" };
              this.btn.textContent = icons[t] ?? icons.dark;
            }
          },
        );
      }

      document.addEventListener("astro:after-swap", () => {
        window.theme.setTheme(window.theme.getTheme());
        initMobileMenu();
      });
    }

    // Global listeners
    window.addEventListener("resize", toggleNavVisibility);
    document.addEventListener("astro:after-swap", initMobileMenu);
    document.addEventListener("astro:after-swap", initNavigationSearch);

    // Initial init
    initMobileMenu();
    initStickyBrandObserver();
    initNavigationSearch();
    initThemeManager();
  })();
</script>
