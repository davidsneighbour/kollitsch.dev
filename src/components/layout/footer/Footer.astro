---
// @todo refactor and comment
import { Image } from "astro:assets";
import patrickkollitsch from "@assets/images/patrick-kollitsch.png";
import Heading from "@components/content/typography/Heading.astro";
import IconLink from "@components/shared/links/IconLink.astro";
import Link from "@components/shared/links/Link.astro";
import type { SocialMediaItem } from "@components/features/social/SocialLinks.astro";
import rawSocialMediaData from "@content/social.json" with { type: "json" };
import rawNavData from "@data/footernavigation.json" with { type: "json" };
import setup from "@data/setup.json" with { type: "json" };
import { getHomepageUrl } from "@utils/content";
import { generateUniqueHtmlId } from "@utils/helpers";

import type { Navigation } from "@utils/navigation";

export interface Props {}

const socialMediaData = rawSocialMediaData as SocialMediaItem[];

const footerYearId = generateUniqueHtmlId();
const currentYear = new Date().getFullYear().toString();
const navData = rawNavData as Navigation;

import SocialLinks from "@components/features/social/SocialLinks.astro";
import MarkdownIt from "markdown-it";
import Colophon from "@components/layout/footer/Colophon.astro";
import { Icon } from "astro-icon/components";

const md = new MarkdownIt();

const introFallback = setup.introduction.replace("{$greeting}", "").trim();
const introFallbackHtml = md.renderInline(introFallback);
---

<footer class={setup.classes.containers.wide} aria-label="Footer">
  <Heading level={2} class="sr-only"> Footer section with navigation and social media links </Heading>
  <div
    class="mt-8 mb-8 grid grid-cols-1 gap-8 border-t-1 border-t-gray-700 bg-gray-50 py-8 md:grid-cols-2 lg:grid-cols-9 xl:grid-cols-7 dark:bg-gray-950"
  >
    <aside
      class="py-4 text-center md:col-span-2 lg:col-span-5 lg:text-left xl:col-span-4"
      aria-label="About section with author image and introduction"
    >
      <Heading level={3} class="mb-4 border-b border-gray-100 dark:border-gray-900"> About </Heading>
      <div class="about-intro text-left">
        <Link href="/connect/" class="about-intro__image">
          <Image
            src={patrickkollitsch}
            alt="Patrick Kollitsch"
            width={256}
            height={256}
            loading="lazy"
            class="about-intro__image-element border-1 border-gray-200 dark:border-gray-800"
          />
        </Link>
        <div id="about-introduction" set:html={introFallbackHtml} />
      </div>
    </aside>
    <aside class="py-4 lg:col-span-2 xl:col-span-1" aria-label="Site navigation links">
      <Heading level={3} class="mb-4 border-b border-gray-100 text-center dark:border-gray-900"> Navigation </Heading>
      <ul class="flex flex-row flex-wrap justify-center gap-2 text-center lg:flex-col lg:justify-end">
        {
          navData.map((value) => (
            <li>
              <IconLink href={value.link} icon={value.icon} linkClass="justify-center">
                {value.label}
              </IconLink>
            </li>
          ))
        }
      </ul>
    </aside>
    <aside class="py-4 lg:col-span-2" aria-label="Social media links">
      <Heading level={3} class="mb-4 border-b border-gray-100 text-center lg:text-right dark:border-gray-900">
        Connect
      </Heading>
      <SocialLinks items={socialMediaData} />
    </aside>
  </div>

  <div class="flex flex-col items-center justify-between border-t border-gray-800 pt-6 md:flex-row">
    <span class="text-center md:text-left"
      >&copy; 2021 &ndash; <span id={footerYearId}>{currentYear}</span>
      <a href={getHomepageUrl()}>{setup.title}</a>
      <span id="site-version" aria-live="polite" aria-atomic="true"></span>
    </span>
    <span class="text-center">All rights reserved.</span>
    <span class="text-center lg:text-right"
      >Webwork done by
      <a href="https://davids-neighbour.com/">David's Neighbour</a></span
    >
  </div>

  <div class="my-4 flex flex-row items-center justify-center gap-8 text-sm">
    <IconLink href="/privacy-policy/" icon="shield-check"> Privacy Policy </IconLink>
    <IconLink href="/security-policy/" icon="fingerprint"> Security Policy </IconLink>
  </div>

  <div class="my-4 flex flex-row items-center justify-center gap-2 text-sm">
    A member of the <a href="https://static.quest">Static.Quest</a> web ring!
    <a href="https://static.quest/previous/?host=kollitsch.dev">
      <Icon name="chevron-left" />
    </a>
    <a href="https://static.quest/members">View Members</a>
    <a href="https://static.quest/next/?host=kollitsch.dev">
      <Icon name="chevron-right" />
    </a>
    <a href="https://static.quest/random">Feeling lucky?</a>
  </div>

  <div class="my-4 flex flex-row items-center justify-center gap-2 text-sm">
    <Icon name="lucide:rss" />
    <Link href="/rss.xml">RSS</Link>
    <Link href="/atom.xml">Atom</Link>
    <Link href="/feed.json">JSON</Link>
  </div>

  <Colophon />

  <script is:inline define:vars={{ footerYearId }} data-astro-rerun>
    document.getElementById(footerYearId).innerText = new Date().getFullYear();

    (async () => {
      try {
        const el = document.getElementById("site-version");
        if (!el) return;
        const resp = await fetch("/api/siteinfo.json");
        if (!resp.ok) return;
        const data = await resp.json();
        const version = data?.version ?? null;
        const releasePage = data?.releasePage ?? null;
        if (version && releasePage) {
          el.textContent = "";
          const separator = document.createTextNode(" áŸš ");
          const link = document.createElement("a");
          Object.assign(link, {
            href: releasePage,
            rel: "noopener noreferrer",
            target: "_blank",
            textContent: `v${version}`,
          });
          el.appendChild(separator);
          el.appendChild(link);
        }
      } catch (err) {
        // silence failures; footer should not break if API is unavailable
      }
    })();
  </script>

  <script>
    import setup from "@data/setup.json" with { type: "json" };
    import MarkdownIt from "markdown-it";

    const md = new MarkdownIt();

    /**
     * Render the introduction with a time-based greeting.
     */
    export function renderIntroduction(introRaw: string, greetings: Record<string, string>): string {
      const hour = new Date().getHours();
      const greeting =
        hour >= 5 && hour < 12
          ? greetings.morning
          : hour >= 12 && hour < 17
            ? greetings.afternoon
            : hour >= 17 && hour < 21
              ? greetings.evening
              : hour >= 21 || hour < 5
                ? greetings.night
                : greetings.default;

      const introFinal = introRaw.replace("{$greeting}", greeting ?? "");
      return md.renderInline(introFinal);
    }

    const target = document.getElementById("about-introduction");
    if (target) {
      const html = renderIntroduction(setup.introduction, setup.greetings);
      target.innerHTML = html;
    }
  </script>

  <style>
    .about-intro {
      text-align: justify;
    }

    .about-intro__image {
      float: left;
      height: 14rem;
      width: 14rem;
      margin: 0 1rem 0.5rem 0;
      shape-outside: circle();
    }

    .about-intro__image-element {
      display: block;
      height: 100%;
      width: 100%;
      border-radius: 9999px;
    }

    @media (max-width: 767px) {
      .about-intro__image {
        float: left;
        height: 10rem;
        width: 10rem;
        margin: 0 0.75rem 0.5rem 0;
        shape-outside: circle();
      }
    }
  </style>
</footer>
