---
// @todo refactor and comment
export interface Props {
  filterId?: string;
}

const { filterId = "default" } = Astro.props;
const safeFilterId = String(filterId).replace(/[^a-zA-Z0-9_-]/g, "-");
const inputId = `tag-filter-input-${safeFilterId}`;
---

<div class="tag-filter" data-tag-filter data-tag-filter-id={filterId}>
  <label class="sr-only" for={inputId}>Filter tags</label>

  <input
    id={inputId}
    type="search"
    inputmode="search"
    autocomplete="off"
    spellcheck="false"
    placeholder="Filter tags..."
    class="form-input w-full rounded-sm"
    data-tag-filter-input
  />

  <div class="mt-2 text-xs text-white/60" data-tag-filter-status aria-live="polite"></div>
</div>

<script>
  /**
   * Returns true if every character in `needle` can be found in order within `haystack`.
   * Example: needle "koll" matches haystack "kollitsch".
   */
  function fuzzyInOrder(haystack: string | any[], needle: string | any[]): boolean {
    if (needle.length === 0) return true;
    let i = 0;
    for (let j = 0; j < haystack.length; j += 1) {
      if (haystack[j] === needle[i]) i += 1;
      if (i === needle.length) return true;
    }
    return false;
  }

  function escapeSelector(value: string): string {
    if (typeof CSS !== "undefined" && typeof CSS.escape === "function") {
      return CSS.escape(value);
    }
    return value.replace(/["\\]/g, "\\$&");
  }

  function initTagFilter(root: HTMLElement): void {
    const input = root.querySelector("[data-tag-filter-input]");
    const status = root.querySelector("[data-tag-filter-status]");
    const filterId = root.getAttribute("data-tag-filter-id") ?? "default";

    if (!(input instanceof HTMLInputElement)) {
      console.error("tag-filter: input not found or wrong type", { root });
      return;
    }

    const selector = `[data-tag-filter-list][data-tag-filter-id="${escapeSelector(filterId)}"]`;
    const lists = Array.from(document.querySelectorAll<HTMLElement>(selector));
    const links = lists.flatMap((list) =>
      Array.from(list.querySelectorAll<HTMLAnchorElement>("a[data-label]")),
    );

    const apply = (q: string) => {
      const query = q.trim().toLowerCase();
      let visible = 0;

      for (const a of links) {
        const label = (a.getAttribute("data-label") ?? "").toLowerCase();
        const match = query === "" ? true : fuzzyInOrder(label, query);
        a.hidden = !match;
        if (match) visible += 1;
      }

      if (status instanceof HTMLElement) {
        status.textContent = links.length === 0 ? "" : `${visible} / ${links.length} tags`;
      }
    };

    // Initial render
    apply(input.value);

    // Avoid double-binding if Astro swaps pages
    if (input.dataset.tagFilterBound === "true") return;
    input.dataset.tagFilterBound = "true";
    const handler = () => apply(input.value);
    input.addEventListener("input", handler, { passive: true });
  }

  function boot() {
    const roots = document.querySelectorAll("[data-tag-filter]");
    for (const el of roots) {
      if (el instanceof HTMLElement) initTagFilter(el);
    }
  }

  document.addEventListener("astro:page-load", boot);
  // Also run once for non-router loads
  boot();
</script>
