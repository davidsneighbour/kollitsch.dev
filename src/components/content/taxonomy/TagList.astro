---
// @todo refactor and comment
/**
 * TagList component
 * - Renders a flat inline list of tags with optional counts
 * - `tags` is an array of TagListItem (id, label, count, url, icon)
 */
import type { TagListItem } from "@utils/tags.ts";
import Tag from "./Tag.astro";

export interface Props {
  tags: TagListItem[];
  showCounts?: boolean;
  filterId?: string;
}

// Props expected from your existing component/usage
const { tags, showCounts = true, filterId = "default" } = Astro.props;
---

<div
  class="mt-2 flex flex-wrap justify-between justify-items-stretch"
  data-tag-filter-list
  data-tag-filter-id={filterId}
>
  {
    tags.length === 0 ? (
      <span>(none)</span>
    ) : (
      tags.map((tag) => {
        const labelText = showCounts ? `${tag.label} (${tag.count})` : tag.label;
        // Lowercase once at render time (avoid locale edge cases in runtime code).
        const labelLower = String(tag.label).toLowerCase();

        return (
          <Tag
            href={tag.url}
            label={labelText}
            dataLabel={labelLower}
            {...(tag.icon && { icon: tag.icon })}
          />
        );
      })
    )
  }
</div>

<script>
  /**
   * Returns true if every character in `needle` can be found in order within `haystack`.
   * Example: needle "koll" matches haystack "kollitsch".
   */
  function fuzzyInOrder(haystack: string | any[], needle: string | any[]): boolean {
    if (needle.length === 0) return true;
    let i = 0;
    for (let j = 0; j < haystack.length; j += 1) {
      if (haystack[j] === needle[i]) i += 1;
      if (i === needle.length) return true;
    }
    return false;
  }

  function initTagFilter(root: HTMLElement): void {
    const input = root.querySelector("[data-tag-filter-input]");
    const list = root.querySelector("[data-tag-filter-list]");
    const status = root.querySelector("[data-tag-filter-status]");

    if (!(input instanceof HTMLInputElement)) {
      console.error("tag-filter: input not found or wrong type", { root });
      return;
    }
    if (!(list instanceof HTMLElement)) {
      console.error("tag-filter: list not found or wrong type", { root });
      return;
    }

    const links = Array.from(list.querySelectorAll<HTMLAnchorElement>("a[data-label]"));

    const apply = (q: string) => {
      const query = q.trim().toLowerCase();
      let visible = 0;

      for (const a of links) {
        const label = (a.getAttribute("data-label") ?? "").toLowerCase();
        const match = query === "" ? true : fuzzyInOrder(label, query);
        a.hidden = !match;
        if (match) visible += 1;
      }

      if (status instanceof HTMLElement) {
        status.textContent = links.length === 0 ? "" : `${visible} / ${links.length} tags`;
      }
    };

    // Initial render
    apply(input.value);

    // Avoid double-binding if Astro swaps pages
    const handler = () => apply(input.value);
    input.addEventListener("input", handler, { passive: true });
  }

  function boot() {
    const roots = document.querySelectorAll("[data-tag-filter]");
    for (const el of roots) {
      if (el instanceof HTMLElement) initTagFilter(el);
    }
  }

  document.addEventListener("astro:page-load", boot);
  // Also run once for non-router loads
  boot();
</script>
